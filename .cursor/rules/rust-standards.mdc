---
description: Rust-specific coding standards for KNHKS
globs:
  - "rust/**/*.rs"
alwaysApply: false
---

# Rust Coding Standards

## Error Handling

- **Never use `unwrap()` or `expect()` in production code paths** - KNHK strict rule

## Input Validation

- **Prohibited**: Defensive programming in execution paths (hot path, executor, state)
- **Required**: Validation at ingress only via guards (`security/guards.rs`)
- Execution paths assume pre-validated inputs - no defensive checks

## Async/Sync Patterns

### ❌ NEVER make trait methods async - breaks dyn compatibility
```rust
// ❌ Bad: Async trait methods break dyn compatibility
pub trait ServicePlugin: Send + Sync {
    async fn start(&self) -> Result<ServiceHandle>; // BREAKS dyn ServicePlugin!
}

// ✅ Good: Keep trait methods sync, use async in implementations
pub trait ServicePlugin: Send + Sync {
    fn start(&self) -> Result<ServiceHandle>; // dyn compatible
}

// Implementation can still be async internally
impl ServicePlugin for MyPlugin {
    fn start(&self) -> Result<ServiceHandle> {
        tokio::task::block_in_place(|| {
            tokio::runtime::Handle::current().block_on(async {
                // Async operations here
                Ok(ServiceHandle::new())
            })
        })
    }
}
```

### ✅ Use async for I/O and long-running operations
- Use `async` for file operations, network, containers, database queries
- Use `sync` for pure computation and simple operations
- Never block async contexts with `std::thread::sleep` - use `tokio::time::sleep` instead

## Trait Design

- Keep traits `dyn` compatible - never use async trait methods

## Testing

- Test guard constraint violations
- **Test behaviors, not implementation details** - Focus on what code does, not how

### Using chicago-tdd-tools

**Required**: Use `chicago-tdd-tools` macros and utilities for all tests.

- **Test macros**: `chicago_test!`, `chicago_async_test!`, `chicago_fixture_test!`, `chicago_performance_test!`
- **Assertion macros**: `assert_ok!`, `assert_err!`, `assert_within_tick_budget!`, `assert_guard_constraint!`
- **Validation utilities**: OTEL validation, performance validation (RDTSC), guard constraint enforcement, Weaver live validation
