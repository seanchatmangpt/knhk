apiVersion: v1
kind: Pod
metadata:
  name: enterprise-app-with-sidecar
  namespace: kgc
  labels:
    app: enterprise-app
    component: app-sidecar
spec:
  containers:
    # Enterprise application container
    - name: enterprise-app
      image: enterprise-app:latest
      ports:
        - containerPort: 8080
          name: http
      env:
        - name: KGC_SIDECAR_ENDPOINT
          value: "localhost:50051"
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "500m"
    
    # KGC Sidecar container
    - name: knhk-sidecar
      image: knhk-sidecar:latest
      ports:
        - containerPort: 50051
          name: grpc
      env:
        - name: LISTEN_ADDR
          valueFrom:
            configMapKeyRef:
              name: knhk-config
              key: SIDECAR_LISTEN_ADDR
        - name: WARM_ORCHESTRATOR_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: knhk-config
              key: WARM_ORCHESTRATOR_ENDPOINT
        - name: BATCH_SIZE
          valueFrom:
            configMapKeyRef:
              name: knhk-config
              key: SIDECAR_BATCH_SIZE
        - name: BATCH_TIMEOUT_MS
          valueFrom:
            configMapKeyRef:
              name: knhk-config
              key: SIDECAR_BATCH_TIMEOUT_MS
      resources:
        requests:
          memory: "128Mi"
          cpu: "50m"
        limits:
          memory: "256Mi"
          cpu: "200m"
      livenessProbe:
        httpGet:
          path: /health
          port: 50051
        initialDelaySeconds: 10
        periodSeconds: 30
      readinessProbe:
        httpGet:
          path: /health
          port: 50051
        initialDelaySeconds: 5
        periodSeconds: 10

