@startuml SPARC Workflow with Quality Gates
!theme plain
title KNHK v1.0 SPARC Development Workflow\n**Schema-First Development with Quality Gates**

skinparam activity {
    BackgroundColor #E8F5E9
    BorderColor #2E7D32
    FontSize 12
    DiamondBackgroundColor #FFF9C4
    DiamondBorderColor #F57C00
}

start

:User defines feature requirements;

partition "**PHASE 1: SPECIFICATION**" {
    :Create OpenTelemetry Weaver schema;
    :Define telemetry behavior in registry/*.yaml;

    if (weaver registry check passes?) then (yes)
        :‚úÖ Schema compiles;
    else (no)
        :‚ùå Fix schema errors;
        stop
    endif

    note right
        **Deliverable**: OTel schema
        **Quality Gate**: Schema validation
        **Transition**: Behavior documented
    end note
}

partition "**PHASE 2: PSEUDOCODE**" {
    :Design algorithm with telemetry markers;
    :Map algorithm flow to schema spans;

    if (Performance ‚â§8 ticks achievable?) then (yes)
        :‚úÖ Algorithm feasible;
    else (no)
        :‚ùå Redesign algorithm;
        stop
    endif

    note right
        **Deliverable**: Algorithm design
        **Quality Gate**: Performance feasibility
        **Transition**: Emits declared telemetry
    end note
}

partition "**PHASE 3: ARCHITECTURE**" {
    :Design system components;
    :Ensure span context propagation;
    :Verify no async trait methods;

    if (Architecture supports schema?) then (yes)
        :‚úÖ Design validated;
    else (no)
        :‚ùå Refactor architecture;
        stop
    endif

    note right
        **Deliverable**: System design
        **Quality Gate**: Telemetry integration
        **Transition**: Supports schema emissions
    end note
}

partition "**PHASE 4: REFINEMENT (CRITICAL GATES)**" #FFE0B2 {
    :Implement feature with TDD;

    if (cargo clippy -D warnings?) then (pass)
        :‚úÖ Gate 4A: Zero warnings;
    else (fail)
        :‚ùå BLOCKER: Fix clippy errors;
        stop
    endif

    if (weaver registry live-check?) then (pass)
        :‚úÖ **Gate 4B: SOURCE OF TRUTH**;
        note right
            **Runtime telemetry matches schema**
            This is the ONLY proof feature works
        end note
    else (fail)
        :‚ùå BLOCKER: Feature DOES NOT WORK;
        stop
    endif

    if (make test-performance-v04?) then (pass)
        :‚úÖ Gate 4C: ‚â§8 ticks;
    else (fail)
        :‚ùå BLOCKER: Optimize hot path;
        stop
    endif

    if (No Ok(()) from unimplemented?) then (yes)
        :‚úÖ Gate 4D: Complete implementation;
    else (no)
        :‚ùå BLOCKER: Complete feature;
        stop
    endif
}

partition "**PHASE 5: COMPLETION (PRODUCTION CERTIFICATION)**" #C8E6C9 {
    :Execute commands with REAL arguments;

    if (Command produces expected output?) then (yes)
        :‚úÖ Gate 5A: Functional;
    else (no)
        :‚ùå BLOCKER: Fix implementation;
        stop
    endif

    if (All 33 DoD criteria met?) then (yes)
        :‚úÖ Gate 5B: Production-ready;
    else (no)
        :‚ùå Complete remaining criteria;
        stop
    endif

    :Archive evidence artifacts;
    :Obtain certification signatures;
}

:üöÄ Deploy to production;

stop

legend right
  |<back:#FFE0B2>   </back>| Phase 4: Critical validation gates |
  |<back:#C8E6C9>   </back>| Phase 5: Production certification |
  |= Symbol |= Meaning |
  | ‚úÖ | Gate passed |
  | ‚ùå | BLOCKER - must fix |
endlegend

note bottom
**Phase Transition Protocol**:
Spec ‚Üí Pseudo: Schema validation passes
Pseudo ‚Üí Arch: Algorithm maps to schema
Arch ‚Üí Refine: Design supports telemetry
Refine ‚Üí Complete: **Weaver live-check passes** (PROVES behavior)
Complete ‚Üí Deploy: Full DoD + functional validation
end note

@enduml
