# KNHK vs unrdf Gap Analysis

**Date**: December 2024  
**Purpose**: Comprehensive comparison of unrdf capabilities vs KNHK's independent implementations to identify gaps for v1.0

## Executive Summary

**Key Finding**: KNHK and unrdf are **complementary**, not overlapping systems. KNHK handles the **hot path** (≤8 ticks), unrdf handles the **cold path** (complex operations). However, there are significant gaps in KNHK's independent implementations that unrdf can fill.

### Architecture Relationship

```
KNHK Architecture:
┌─────────────────────────────────────────┐
│         Hot Path (C)                     │
│         ≤8 ticks (2ns)                   │
│         Micro-operations                 │
│         (18 operations)                  │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         Warm Path (Rust)                │
│         ≤500ms                          │
│         Coordination, timing            │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         Cold Path (Rust → unrdf)        │
│         >500ms                          │
│         Complex queries, hooks           │
└─────────────────────────────────────────┘
```

## Feature-by-Feature Comparison

### 1. SPARQL Query Support

#### unrdf Provides ✅
- **Full SPARQL 1.1** via Comunica:
  - SELECT queries (with JOINs, OPTIONAL, UNION, GROUP BY, ORDER BY)
  - ASK queries (full SPARQL ASK)
  - CONSTRUCT queries
  - DESCRIBE queries
  - UPDATE queries (INSERT, DELETE, INSERT WHERE, DELETE WHERE)
  - Complex patterns (property paths, FILTER, BIND, aggregates)

#### KNHK Independent Implementation ✅
- **Micro-operations** (18 operations optimized for ≤8 ticks):
  - `KNHK_OP_ASK_SP` - Subject-predicate existence check
  - `KNHK_OP_ASK_SPO` - Triple matching
  - `KNHK_OP_COUNT_SP_GE/LE/EQ` - Cardinality checks
  - `KNHK_OP_COMPARE_O_*` - Object value comparisons
  - `KNHK_OP_VALIDATE_DATATYPE_*` - Datatype validation
  - `KNHK_OP_CONSTRUCT8` - Fixed-template emit (≤8 triples)

**Gap Analysis**:
- ✅ **No Gap** - Complementary systems
- KNHK hot path handles **micro-operations** (≤8 ticks)
- unrdf cold path handles **full SPARQL** (complex queries)
- **Action**: Route complex queries to unrdf via `knhk_unrdf_query()`

**Status**: ✅ **Well-integrated** - Basic routing exists, needs expansion for all query types

---

### 2. SHACL Validation

#### unrdf Provides ✅
- **Full SHACL validation** via rdf-validate-shacl:
  - Complete SHACL Core specification
  - Node shapes, property shapes
  - All constraint types (minCount, maxCount, datatype, class, in, hasValue, pattern, etc.)
  - Complex shapes (and, or, not, xone)
  - Severity levels (sh:Violation, sh:Warning, sh:Info)
  - Custom validation functions

#### KNHK Independent Implementation ⚠️
- **Micro-shape validation** (limited to hot path constraints):
  - `KNHK_OP_VALIDATE_DATATYPE_SP/SPO` - Datatype checks
  - Basic cardinality checks (via COUNT operations)
  - **No full SHACL implementation**

**Gap Analysis**:
- ⚠️ **Significant Gap** - KNHK has no SHACL validation wrapper
- KNHK can validate **micro-shapes** in hot path (limited)
- unrdf provides **full SHACL** validation
- **Action**: Wrap unrdf's `validateShacl()` function for cold path validation

**Status**: ⚠️ **Not Integrated** - Missing `knhk_unrdf_validate_shacl()` wrapper

---

### 3. RDF Parsing & Serialization

#### unrdf Provides ✅
- **Complete RDF I/O**:
  - `parseTurtle()` - Parse Turtle → Store
  - `parseJsonLd()` - Parse JSON-LD → Store
  - `toTurtle()` - Store → Turtle
  - `toJsonLd()` - Store → JSON-LD
  - `toNQuads()` - Store → N-Quads
  - Full Turtle syntax support (prefixes, blank nodes, base URIs, literals)

#### KNHK Independent Implementation ✅
- **RDF Parsing**:
  - **C**: Raptor library (`c/src/rdf.c`) - File-based Turtle parsing
  - **Rust**: `rio_turtle` library (`rust/knhk-etl/src/lib.rs`) - Full Turtle parsing with streaming support
  - Full Turtle syntax support (prefixes, blank nodes, base URIs, literals)
  - N-Quads parsing support (via rio_turtle)

- **RDF Serialization**:
  - ⚠️ **Missing** - No serialization implementation

**Gap Analysis**:
- ⚠️ **Partial Gap** - KNHK has parsing, lacks serialization
- KNHK can **parse** Turtle/N-Quads independently
- unrdf provides **serialization** (toTurtle, toJsonLd, toNQuads)
- **Action**: Wrap unrdf's serialization functions OR implement independent serialization

**Status**: ⚠️ **Partial Integration** - Parsing exists, serialization missing

---

### 4. Knowledge Hooks / Policy Validation

#### unrdf Provides ✅
- **Knowledge Hooks** (policy-driven automation):
  - `sparql-ask` - Boolean queries
  - `shacl` - Shape validation
  - `delta` - Change detection (URDNA2015 canonical hashes)
  - `threshold` - Numeric comparisons
  - `count` - Cardinality checks
  - `window` - Time-based aggregations
  - Hook lifecycle: `before`, `run`, `after`
  - Effect sandboxing (VM2 isolation)
  - Policy pack integration

#### KNHK Independent Implementation ✅
- **Hot Path Hooks** (micro-operations):
  - 18 micro-operations (ASK_SP, COUNT_SP_GE, etc.)
  - AOT-compiled to branchless bit-ops
  - ≤8 tick execution guarantee
  - Guard validation (max_run_len ≤ 8)
  - Erlang hook registry (`knhk_hooks.erl`)

**Gap Analysis**:
- ✅ **No Gap** - Different hook systems for different purposes
- KNHK hot path hooks: **Micro-operations** for ≤8 tick execution
- unrdf hooks: **Policy-driven automation** for complex workflows
- **Action**: Integrate unrdf hooks for cold path policy validation

**Status**: ⚠️ **Partial Integration** - Basic hook execution exists, needs full hook management

---

### 5. Lockchain / Cryptographic Provenance

#### unrdf Provides ✅
- **Git-based Lockchain**:
  - SHA3-256 Merkle tree verification
  - Git-anchored audit logs
  - Receipt linking and verification
  - Tamper detection
  - Git notes integration

#### KNHK Independent Implementation ✅
- **Lockchain Implementation**:
  - **Rust**: `knhk-lockchain` crate (`rust/knhk-lockchain/src/lib.rs`)
    - SHA-256 hashing (not SHA3-256)
    - URDNA2015 canonicalization
    - Merkle tree building
    - Receipt storage and verification
    - Git repository integration (optional)
  - **Erlang**: `knhk_lockchain.erl`
    - Receipt storage
    - Merkle root computation
    - Receipt merging (Π ⊕)

**Gap Analysis**:
- ⚠️ **Hash Algorithm Mismatch**:
  - KNHK uses **SHA-256**
  - unrdf uses **SHA3-256**
- Both use Merkle trees and Git storage
- **Action**: Decide on unified hash algorithm OR align implementations

**Status**: ⚠️ **Separate Implementations** - Need alignment (SHA-256 vs SHA3-256)

---

### 6. Transaction Management

#### unrdf Provides ✅
- **ACID Transaction Manager**:
  - `executeTransaction()` - ACID guarantees
  - Rollback support
  - Hook lifecycle integration
  - OTEL instrumentation
  - Actor tracking
  - Delta management (additions/removals)

#### KNHK Independent Implementation ⚠️
- **No Transaction Manager**:
  - KNHK has hot path operations (atomic by design)
  - No ACID transaction support
  - No rollback mechanism
  - No transaction lifecycle management

**Gap Analysis**:
- ⚠️ **Significant Gap** - KNHK lacks transaction management
- unrdf provides full ACID transaction support
- **Action**: Wrap unrdf's `TransactionManager` for cold path transactions

**Status**: ⚠️ **Not Integrated** - Missing transaction management wrapper

---

### 7. Observability (OTEL)

#### unrdf Provides ✅
- **OTEL Observability**:
  - Automatic span creation for all operations
  - Performance metrics (p50, p95, drift, throughput)
  - Traces (full request lifecycle)
  - Receipt-to-span linking
  - ObservabilityManager class

#### KNHK Independent Implementation ✅
- **OTEL Integration**:
  - **Rust**: `knhk-otel` crate (`rust/knhk-otel/src/lib.rs`)
    - Span creation and management
    - Metrics recording
    - OTLP exporter
    - Weaver live-check integration
    - Trace ID and Span ID generation

**Gap Analysis**:
- ⚠️ **Partial Gap** - Separate OTEL implementations
- KNHK has its own OTEL integration
- unrdf has its own OTEL integration
- **Action**: Unify OTEL spans/metrics across hot/warm/cold paths

**Status**: ⚠️ **Separate Implementations** - Need unified observability

---

### 8. Dark Matter 80/20 Optimization

#### unrdf Provides ✅
- **Performance Optimizations**:
  - Hook execution batching (30-50% faster)
  - LRU query caching (40-60% faster)
  - Parallel independent hook execution
  - Memory-efficient resource management
  - Performance targets: p50 ≤200µs, p99 ≤2ms

#### KNHK Independent Implementation ✅
- **Hot Path Optimization**:
  - SIMD operations (NEON/AVX2)
  - Branchless operations
  - SoA data layout (64-byte alignment)
  - Cache-aware operations (L1 cache targeting)
  - Performance target: ≤8 ticks (≤2ns)

**Gap Analysis**:
- ✅ **No Gap** - Different optimization strategies
- KNHK optimizes for **hot path** (≤8 ticks)
- unrdf optimizes for **cold path** (query caching, batching)
- **Action**: Use unrdf optimizations for cold path queries

**Status**: ⚠️ **Not Integrated** - unrdf optimizations not exposed via KNHK API

---

### 9. Policy Packs

#### unrdf Provides ✅
- **Policy Pack Management**:
  - Versioned governance units
  - Policy pack loading
  - Dependency management
  - Policy synchronization

#### KNHK Independent Implementation ⚠️
- **No Policy Pack System**:
  - KNHK uses **guards** (H constraints)
  - Schema validation (Σ)
  - Invariant preservation (Q)
  - No policy pack management

**Gap Analysis**:
- ⚠️ **Gap** - KNHK lacks policy pack management
- unrdf provides policy pack system
- **Action**: Integrate unrdf's PolicyPackManager OR implement independent policy pack system

**Status**: ⚠️ **Not Integrated** - Missing policy pack support

---

## Summary: Gap Matrix

| Feature | unrdf Provides | KNHK Independent | Gap Status | Action Required |
|---------|----------------|------------------|-----------|----------------|
| **SPARQL Queries** | Full SPARQL 1.1 | Micro-operations (18 ops) | ✅ Complementary | Expand query routing |
| **SHACL Validation** | Full SHACL | Micro-shapes only | ⚠️ Missing | Wrap `validateShacl()` |
| **RDF Parsing** | Turtle, JSON-LD | Turtle (Raptor, rio_turtle) | ✅ Has parsing | None |
| **RDF Serialization** | Turtle, JSON-LD, N-Quads | None | ⚠️ Missing | Wrap serialization OR implement |
| **Knowledge Hooks** | Policy-driven (6 types) | Hot path micro-ops | ✅ Complementary | Expand hook management |
| **Lockchain** | SHA3-256, Git | SHA-256, Git | ⚠️ Mismatch | Align hash algorithm |
| **Transaction Mgmt** | ACID transactions | None | ⚠️ Missing | Wrap TransactionManager |
| **OTEL Observability** | Full OTEL | Independent OTEL | ⚠️ Separate | Unify spans/metrics |
| **Optimization** | Caching, batching | SIMD, branchless | ✅ Complementary | Expose optimizations |
| **Policy Packs** | Policy pack mgmt | None | ⚠️ Missing | Integrate PolicyPackManager |

## Critical Gaps for v1.0

### P0 (Must Have)

1. **SHACL Validation** ⚠️
   - **Gap**: No SHACL validation wrapper
   - **Impact**: Cannot validate complex shapes
   - **Action**: Wrap unrdf's `validateShacl()` function
   - **Priority**: Critical

2. **Transaction Management** ⚠️
   - **Gap**: No ACID transaction support
   - **Impact**: Cannot manage complex transactions with rollback
   - **Action**: Wrap unrdf's `TransactionManager`
   - **Priority**: Critical

3. **Full SPARQL Query Support** ⚠️
   - **Gap**: Only basic SELECT queries wrapped
   - **Impact**: Cannot route ASK, CONSTRUCT, DESCRIBE, UPDATE queries
   - **Action**: Expand `knhk_unrdf_query()` to support all query types
   - **Priority**: Critical

### P1 (Should Have)

4. **RDF Serialization** ⚠️
   - **Gap**: Cannot serialize RDF data
   - **Impact**: Cannot output Turtle/JSON-LD/N-Quads
   - **Action**: Wrap unrdf's serialization functions OR implement independently
   - **Priority**: High

5. **Hook Management** ⚠️
   - **Gap**: Only basic hook execution, no registration/deregistration
   - **Impact**: Cannot manage hook lifecycle
   - **Action**: Wrap unrdf's hook management functions
   - **Priority**: High

6. **Lockchain Alignment** ⚠️
   - **Gap**: Hash algorithm mismatch (SHA-256 vs SHA3-256)
   - **Impact**: Cannot cross-reference receipts
   - **Action**: Decide on unified hash algorithm
   - **Priority**: High

### P2 (Nice to Have)

7. **Policy Pack Support** ⚠️
   - **Gap**: No policy pack management
   - **Impact**: Cannot use versioned governance units
   - **Action**: Integrate unrdf's PolicyPackManager
   - **Priority**: Medium

8. **Unified Observability** ⚠️
   - **Gap**: Separate OTEL implementations
   - **Impact**: Cannot unify spans/metrics across paths
   - **Action**: Unify OTEL instrumentation
   - **Priority**: Medium

9. **Optimization Exposure** ⚠️
   - **Gap**: unrdf optimizations not exposed
   - **Impact**: Missing query caching and batching
   - **Action**: Expose optimization features via API
   - **Priority**: Low

## Integration Recommendations

### Strategy 1: Wrap unrdf Features (Recommended)

**Approach**: Create FFI wrappers for unrdf features KNHK lacks

**Pros**:
- Reuse production-ready unrdf implementations
- Faster development
- Maintains separation of concerns

**Cons**:
- Dependency on unrdf API
- Potential performance overhead (FFI)

**Actions**:
1. Wrap `validateShacl()` → `knhk_unrdf_validate_shacl()`
2. Wrap `TransactionManager` → `knhk_unrdf_transaction_*()`
3. Expand `knhk_unrdf_query()` for all query types
4. Wrap serialization functions

### Strategy 2: Implement Independently

**Approach**: Implement missing features in KNHK independently

**Pros**:
- No dependency on unrdf
- Full control over implementation
- Potentially better performance

**Cons**:
- More development time
- Duplicate implementations
- Maintenance burden

**Actions**:
1. Implement SHACL validation in Rust/C
2. Implement transaction management
3. Implement RDF serialization
4. Implement policy pack system

### Strategy 3: Hybrid Approach (Recommended)

**Approach**: Use unrdf for complex features, implement simple features independently

**Recommendation**:
- **Wrap unrdf**: SHACL validation, transaction management, complex SPARQL queries
- **Implement independently**: RDF serialization (simpler), basic hook management
- **Align**: Lockchain hash algorithm, OTEL spans

## Implementation Priority

### Phase 1: Critical Gaps (v1.0 P0)

1. ✅ Expand SPARQL query routing (all query types)
2. ✅ Wrap SHACL validation
3. ✅ Wrap transaction management

### Phase 2: High Priority (v1.0 P1)

4. ✅ Add RDF serialization (wrap or implement)
5. ✅ Expand hook management API
6. ✅ Align lockchain hash algorithm

### Phase 3: Nice to Have (v1.0 P2)

7. ✅ Integrate policy packs
8. ✅ Unify OTEL observability
9. ✅ Expose optimization features

## Conclusion

**Key Insight**: KNHK and unrdf are **complementary systems**:
- **KNHK**: Hot path micro-operations (≤8 ticks)
- **unrdf**: Cold path complex operations (full SPARQL/SHACL)

**Critical Gaps**:
1. **SHACL Validation** - Must wrap unrdf's validation
2. **Transaction Management** - Must wrap unrdf's TransactionManager
3. **Full SPARQL Support** - Must expand query routing

**Alignment Issues**:
1. **Lockchain Hash** - SHA-256 vs SHA3-256 (need decision)
2. **OTEL Spans** - Separate implementations (need unification)

**Recommendation**: **Hybrid approach** - Wrap unrdf for complex features, implement simple features independently, align hash algorithms and OTEL spans.

---

**Status**: Gap Analysis Complete  
**Next Action**: Prioritize gaps and create implementation plan for v1.0

