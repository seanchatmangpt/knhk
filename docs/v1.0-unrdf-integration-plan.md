# KNHK v1.0 unrdf Integration Analysis

**Date**: December 2024  
**Purpose**: Analyze unrdf README to determine what needs to be supported, wrapped, refactored, or implemented for KNHK v1.0

## Executive Summary

unrdf v3.0.0 is a production-ready RDF knowledge graph library that provides:
- **Full SPARQL 1.1** support via Comunica
- **SHACL validation** via rdf-validate-shacl
- **Knowledge Hooks** for policy-driven automation
- **Cryptographic Provenance** with Git-based lockchain
- **Dark Matter 80/20** optimization framework

**Integration Strategy**: unrdf serves as the **cold path** for complex queries that exceed KNHK's ≤8 tick hot path budget. KNHK handles the critical 20% (simple queries), unrdf handles the remaining 80% (complex operations).

## Current Integration Status

### ✅ Implemented (v0.4.0)

**Rust Integration Layer** (`rust/knhk-unrdf/`):
- ✅ `knhk_unrdf_init()` - Initialize unrdf integration
- ✅ `knhk_unrdf_store_turtle()` - Store RDF data in unrdf
- ✅ `knhk_unrdf_query()` - Execute SPARQL queries via unrdf
- ✅ `knhk_unrdf_execute_hook()` - Execute knowledge hooks via unrdf

**C FFI Interface** (`c/include/knhk/unrdf.h`):
- ✅ FFI-safe C interface declarations
- ✅ Basic cold path integration

**Architecture**:
- ✅ Rust as integration layer (Tokio runtime)
- ✅ Node.js process spawning for unrdf execution
- ✅ JSON-based result passing

### ⚠️ Limitations (v0.4.0)

- ⚠️ **Basic Integration Only** - Only core SPARQL queries and hooks
- ⚠️ **No Transaction Management** - Missing ACID transaction support
- ⚠️ **No SHACL Validation** - Missing SHACL validation wrapper
- ⚠️ **No Lockchain Integration** - Missing cryptographic provenance
- ⚠️ **No Dark Matter Optimization** - Missing 80/20 optimization features
- ⚠️ **No Policy Pack Support** - Missing policy pack integration
- ⚠️ **No Observability** - Missing OTEL integration from unrdf side

## unrdf Features Requiring v1.0 Support

### 1. Core Knowledge Engine ✅ (Partially Implemented)

**Status**: Basic implementation exists, needs expansion

**Current Support**:
- ✅ Basic SPARQL SELECT queries
- ✅ Basic knowledge hook execution
- ✅ Turtle data storage

**Missing for v1.0**:
- ⚠️ **Full SPARQL Support**:
  - ASK queries (currently basic)
  - CONSTRUCT queries (not implemented)
  - DESCRIBE queries (not implemented)
  - UPDATE queries (INSERT/DELETE) - not implemented
  - Complex queries (JOINs, OPTIONAL, UNION) - basic only

**Action Required**:
- **Wrap**: Expand `knhk_unrdf_query()` to support all SPARQL query types
- **Implement**: Query type detection and routing
- **Refactor**: Separate query execution from result parsing

### 2. RDF Parsing & Serialization ⚠️ (Not Implemented)

**unrdf Provides**:
- `parseTurtle()` - Parse Turtle → Store
- `parseJsonLd()` - Parse JSON-LD → Store
- `toTurtle()` - Store → Turtle
- `toJsonLd()` - Store → JSON-LD
- `toNQuads()` - Store → N-Quads

**Current Status**: Only basic Turtle storage via `store_turtle_data()`

**Missing for v1.0**:
- ⚠️ JSON-LD parsing
- ⚠️ RDF serialization (toTurtle, toJsonLd, toNQuads)
- ⚠️ Format detection and conversion

**Action Required**:
- **Wrap**: Add `knhk_unrdf_parse_jsonld()` function
- **Wrap**: Add `knhk_unrdf_to_turtle()` serialization function
- **Wrap**: Add `knhk_unrdf_to_jsonld()` serialization function
- **Implement**: Format conversion utilities

### 3. SHACL Validation ⚠️ (Not Implemented)

**unrdf Provides**:
```javascript
const validation = await system.validate({
  dataGraph: store,
  shapesGraph: shapes
});
```

**Current Status**: Not implemented in KNHK integration

**Missing for v1.0**:
- ⚠️ SHACL validation wrapper
- ⚠️ Shape graph loading
- ⚠️ Validation result parsing

**Action Required**:
- **Wrap**: Add `knhk_unrdf_validate_shacl()` function
- **Implement**: Shape graph management
- **Implement**: Validation result serialization

### 4. Knowledge Hooks ⚠️ (Basic Implementation Only)

**unrdf Provides**:
- `defineHook()` - Define hook schema
- `registerHook()` - Register hook with manager
- `deregisterHook()` - Remove hook
- `evaluateHook()` - Manually evaluate hook

**Hook Types**:
- `sparql-ask` - Boolean queries ✅ (basic support)
- `shacl` - Shape validation ⚠️ (not implemented)
- `delta` - Change detection ⚠️ (not implemented)
- `threshold` - Numeric comparisons ⚠️ (not implemented)
- `count` - Cardinality checks ⚠️ (not implemented)
- `window` - Time-based aggregations ⚠️ (not implemented)

**Current Status**: Only basic `sparql-ask` hooks via `execute_hook()`

**Missing for v1.0**:
- ⚠️ Hook registration/deregistration
- ⚠️ Hook lifecycle management (before/run/after)
- ⚠️ Multiple hook types (SHACL, delta, threshold, count, window)
- ⚠️ Hook persistence

**Action Required**:
- **Wrap**: Add `knhk_unrdf_register_hook()` function
- **Wrap**: Add `knhk_unrdf_deregister_hook()` function
- **Wrap**: Add `knhk_unrdf_list_hooks()` function
- **Refactor**: Expand hook execution to support all hook types
- **Implement**: Hook registry management

### 5. Transaction Manager ⚠️ (Not Implemented)

**unrdf Provides**:
```javascript
await system.executeTransaction({
  additions: [/* quads */],
  removals: [/* quads */],
  actor: 'user@example.org'
});
```

**Features**:
- ACID guarantees
- Rollback support
- Hook lifecycle integration
- OTEL instrumentation

**Current Status**: Not implemented - only basic data storage

**Missing for v1.0**:
- ⚠️ Transaction execution with additions/removals
- ⚠️ Transaction rollback support
- ⚠️ Actor tracking
- ⚠️ Hook integration in transactions

**Action Required**:
- **Wrap**: Add `knhk_unrdf_execute_transaction()` function
- **Wrap**: Add `knhk_unrdf_rollback_transaction()` function
- **Implement**: Transaction state management
- **Implement**: Error handling and rollback logic

### 6. Lockchain Integration ⚠️ (Not Implemented)

**unrdf Provides**:
```javascript
const lockchain = new LockchainWriter({
  repoPath: './lockchain-repo',
  enableMerkle: true
});

const receipt = await lockchain.writeReceipt({
  actor: 'alice@example.org',
  action: 'add-data',
  delta: { additions: [/* quads */], removals: [] },
  timestamp: new Date(),
  metadata: { reason: 'User registration' }
});

const isValid = await lockchain.verifyReceipt(receipt);
```

**Features**:
- Git-based immutable audit log
- SHA3-256 Merkle root verification
- Receipt linking and querying
- Tamper detection

**Current Status**: KNHK has its own lockchain (`knhk-lockchain` crate), but unrdf lockchain is not integrated

**Missing for v1.0**:
- ⚠️ unrdf lockchain integration (or alignment with KNHK lockchain)
- ⚠️ Receipt writing via unrdf
- ⚠️ Receipt verification
- ⚠️ Merkle root verification (SHA3-256 vs SHA-256 alignment)

**Action Required**:
- **Decision**: Align lockchain implementations (SHA-256 vs SHA3-256)
- **Wrap**: Add `knhk_unrdf_write_receipt()` function (if using unrdf lockchain)
- **Wrap**: Add `knhk_unrdf_verify_receipt()` function
- **Refactor**: Unify receipt format between KNHK and unrdf

### 7. Dark Matter 80/20 Optimization ⚠️ (Not Implemented)

**unrdf Provides**:
- Hook execution batching (30-50% faster)
- LRU query caching (40-60% faster)
- Parallel independent hook execution
- Memory-efficient resource management

**Performance Targets**:
- <100ms p95 hook execution latency
- <500ms p95 query execution latency
- <500ms p95 transaction commit latency
- 50%+ cache hit rate after warmup

**Current Status**: Not implemented in KNHK integration

**Missing for v1.0**:
- ⚠️ Query caching (LRU cache)
- ⚠️ Hook batching
- ⚠️ Parallel execution optimization
- ⚠️ Performance metrics collection

**Action Required**:
- **Wrap**: Add caching layer for query results
- **Implement**: Hook batching logic
- **Implement**: Performance metrics collection
- **Refactor**: Optimize query execution path

### 8. Observability (OTEL) ⚠️ (Partial Implementation)

**unrdf Provides**:
```javascript
import { Observability } from 'unrdf';

const obs = new Observability();
const metrics = obs.getPerformanceMetrics();
```

**Features**:
- Automatic span creation for all operations
- Metrics: p50, p95, drift, throughput
- Traces: Full request lifecycle
- Receipts link to OTEL spans

**Current Status**: KNHK has OTEL integration (`knhk-otel` crate), but unrdf OTEL is not integrated

**Missing for v1.0**:
- ⚠️ unrdf OTEL integration
- ⚠️ Unified observability across hot/warm/cold paths
- ⚠️ Performance metrics aggregation

**Action Required**:
- **Wrap**: Integrate unrdf Observability class
- **Implement**: Unified metrics collection
- **Refactor**: Align OTEL spans between KNHK and unrdf

### 9. Policy Packs ⚠️ (Not Implemented)

**unrdf Provides**:
- Versioned governance units
- Policy pack management
- Policy synchronization

**Current Status**: Not implemented

**Missing for v1.0**:
- ⚠️ Policy pack loading
- ⚠️ Policy pack management
- ⚠️ Policy synchronization with KNHK guards

**Action Required**:
- **Wrap**: Add policy pack management functions
- **Implement**: Policy pack registry
- **Refactor**: Align with KNHK guard system

## Integration Architecture for v1.0

### Recommended Architecture

```
┌─────────────────────────────────────────┐
│         KNHK v1.0 System               │
├─────────────────────────────────────────┤
│                                         │
│  Hot Path (C)                           │
│  ≤8 ticks: Simple queries               │
│                                         │
│  Warm Path (Rust)                       │
│  ≤500ms: Coordination, timing          │
│                                         │
│  Cold Path (Rust → unrdf)               │
│  >500ms: Complex queries, hooks         │
│    ├─ SPARQL (Comunica)                 │
│    ├─ SHACL Validation                  │
│    ├─ Knowledge Hooks                   │
│    ├─ Transaction Manager              │
│    └─ Lockchain (aligned)               │
└─────────────────────────────────────────┘
```

## Priority Ranking for v1.0

### P0 (Critical - Must Have)

1. **Full SPARQL Support** ⚠️
   - Expand query types (ASK, CONSTRUCT, UPDATE)
   - Complex query routing
   - **Wrap**: Expand `knhk_unrdf_query()` API

2. **Transaction Management** ⚠️
   - ACID transaction support
   - Rollback capabilities
   - **Wrap**: Add `knhk_unrdf_execute_transaction()` API

3. **SHACL Validation** ⚠️
   - Shape validation wrapper
   - **Wrap**: Add `knhk_unrdf_validate_shacl()` API

### P1 (High Priority - Should Have)

4. **Knowledge Hooks Expansion** ⚠️
   - Hook registration/deregistration
   - Multiple hook types
   - **Wrap**: Expand hook management API

5. **RDF Serialization** ⚠️
   - Turtle/JSON-LD/N-Quads output
   - **Wrap**: Add serialization functions

6. **Lockchain Alignment** ⚠️
   - Align SHA-256 vs SHA3-256
   - Unified receipt format
   - **Refactor**: Unify lockchain implementations

### P2 (Medium Priority - Nice to Have)

7. **Dark Matter Optimization** ⚠️
   - Query caching
   - Hook batching
   - **Implement**: Optimization layer

8. **Observability Integration** ⚠️
   - Unified OTEL spans
   - Performance metrics
   - **Refactor**: Align OTEL instrumentation

9. **Policy Pack Support** ⚠️
   - Policy pack management
   - **Wrap**: Add policy pack API

## Implementation Plan

### Phase 1: Core Query Expansion (P0)

**Target**: Expand SPARQL support and transaction management

**Tasks**:
1. **Wrap** `knhk_unrdf_query()` to support:
   - ASK queries (enhance existing)
   - CONSTRUCT queries (new)
   - DESCRIBE queries (new)
   - UPDATE queries (INSERT/DELETE) (new)

2. **Wrap** Transaction Management:
   - `knhk_unrdf_execute_transaction()` - Execute transaction with additions/removals
   - `knhk_unrdf_rollback_transaction()` - Rollback transaction

3. **Implement** Query type detection:
   - Parse SPARQL query to determine type
   - Route to appropriate unrdf function

### Phase 2: Validation & Hooks (P0)

**Target**: SHACL validation and expanded hook support

**Tasks**:
1. **Wrap** SHACL Validation:
   - `knhk_unrdf_validate_shacl()` - Validate data graph against shapes

2. **Wrap** Hook Management:
   - `knhk_unrdf_register_hook()` - Register hook
   - `knhk_unrdf_deregister_hook()` - Remove hook
   - `knhk_unrdf_list_hooks()` - List registered hooks

3. **Implement** Hook type support:
   - SHACL hooks
   - Delta hooks
   - Threshold hooks
   - Count hooks
   - Window hooks

### Phase 3: Serialization & Lockchain (P1)

**Target**: RDF serialization and lockchain alignment

**Tasks**:
1. **Wrap** RDF Serialization:
   - `knhk_unrdf_to_turtle()` - Serialize to Turtle
   - `knhk_unrdf_to_jsonld()` - Serialize to JSON-LD
   - `knhk_unrdf_to_nquads()` - Serialize to N-Quads

2. **Refactor** Lockchain:
   - Decide on hash algorithm (SHA-256 vs SHA3-256)
   - Unify receipt format
   - Integrate unrdf lockchain (or align implementations)

### Phase 4: Optimization & Observability (P2)

**Target**: Performance optimization and unified observability

**Tasks**:
1. **Implement** Optimization:
   - Query result caching (LRU)
   - Hook batching
   - Parallel execution

2. **Refactor** Observability:
   - Integrate unrdf Observability class
   - Unify OTEL spans
   - Aggregate performance metrics

3. **Wrap** Policy Packs:
   - Policy pack loading
   - Policy pack management

## API Design for v1.0

### Enhanced C API (`c/include/knhk/unrdf.h`)

```c
// Existing (v0.4.0)
int knhk_unrdf_init(const char *unrdf_path);
int knhk_unrdf_store_turtle(const char *turtle_data);
int knhk_unrdf_query(const char *query, char *result_json, size_t result_size);
int knhk_unrdf_execute_hook(const char *hook_name, const char *hook_query, char *result_json, size_t result_size);

// New for v1.0 - Query Expansion
int knhk_unrdf_query_ask(const char *query, int *result);
int knhk_unrdf_query_construct(const char *query, char *result_json, size_t result_size);
int knhk_unrdf_query_describe(const char *query, char *result_json, size_t result_size);
int knhk_unrdf_query_update(const char *query, char *result_json, size_t result_size);

// New for v1.0 - Transaction Management
int knhk_unrdf_transaction_begin(void);
int knhk_unrdf_transaction_commit(int transaction_id, char *receipt_json, size_t receipt_size);
int knhk_unrdf_transaction_rollback(int transaction_id);
int knhk_unrdf_transaction_add(int transaction_id, const char *turtle_data);
int knhk_unrdf_transaction_remove(int transaction_id, const char *turtle_data);

// New for v1.0 - SHACL Validation
int knhk_unrdf_validate_shacl(const char *data_turtle, const char *shapes_turtle, char *result_json, size_t result_size);

// New for v1.0 - Hook Management
int knhk_unrdf_register_hook(const char *hook_json, char *hook_id, size_t id_size);
int knhk_unrdf_deregister_hook(const char *hook_id);
int knhk_unrdf_list_hooks(char *hooks_json, size_t hooks_size);

// New for v1.0 - RDF Serialization
int knhk_unrdf_to_turtle(char *turtle_output, size_t output_size);
int knhk_unrdf_to_jsonld(char *jsonld_output, size_t output_size);
int knhk_unrdf_to_nquads(char *nquads_output, size_t output_size);

// New for v1.0 - Lockchain (if using unrdf lockchain)
int knhk_unrdf_lockchain_init(const char *repo_path);
int knhk_unrdf_lockchain_write_receipt(const char *receipt_json, char *receipt_id, size_t id_size);
int knhk_unrdf_lockchain_verify_receipt(const char *receipt_id, int *is_valid);
```

## Refactoring Required

### 1. Rust Integration Layer (`rust/knhk-unrdf/`)

**Current Issues**:
- ⚠️ Script-based execution (temporary files)
- ⚠️ No persistent state management
- ⚠️ No connection pooling
- ⚠️ Limited error handling

**Refactoring Tasks**:
1. **Implement** persistent unrdf system instance
2. **Refactor** from script execution to direct API calls (if possible)
3. **Implement** connection pooling for Node.js processes
4. **Enhance** error handling with detailed error types

### 2. Error Handling

**Current**: Basic error codes (-1 on error)

**Required**:
- **Refactor** to return detailed error information
- **Implement** error code enumeration
- **Wrap** unrdf errors into KNHK error types

### 3. State Management

**Current**: Single global state (`OnceLock`)

**Required**:
- **Refactor** to support multiple unrdf instances
- **Implement** instance management
- **Implement** cleanup and resource management

## Implementation Gaps

### Critical Gaps

1. **No Persistent unrdf Instance** ⚠️
   - Current: Creates new system per operation
   - Required: Single persistent instance with state

2. **No Transaction Support** ⚠️
   - Current: Only basic data storage
   - Required: Full ACID transaction support

3. **No SHACL Validation** ⚠️
   - Current: Not implemented
   - Required: Full SHACL validation wrapper

4. **Limited Hook Support** ⚠️
   - Current: Only basic sparql-ask hooks
   - Required: All hook types (SHACL, delta, threshold, count, window)

5. **No Serialization** ⚠️
   - Current: Only storage, no retrieval/serialization
   - Required: Turtle/JSON-LD/N-Quads output

### Architecture Gaps

1. **No Lockchain Alignment** ⚠️
   - KNHK uses SHA-256, unrdf uses SHA3-256
   - Required: Unified approach

2. **No Observability Integration** ⚠️
   - Separate OTEL implementations
   - Required: Unified spans and metrics

3. **No Optimization Layer** ⚠️
   - Missing caching and batching
   - Required: Dark Matter optimization features

## Success Criteria for v1.0

### Must Have (P0)

- ✅ Full SPARQL 1.1 support (SELECT, ASK, CONSTRUCT, DESCRIBE, UPDATE)
- ✅ ACID transaction management
- ✅ SHACL validation wrapper
- ✅ Basic hook management (register/deregister/list)

### Should Have (P1)

- ✅ RDF serialization (Turtle, JSON-LD, N-Quads)
- ✅ Lockchain alignment (SHA-256 vs SHA3-256 decision)
- ✅ Expanded hook types (SHACL, delta, threshold, count, window)

### Nice to Have (P2)

- ✅ Query caching (LRU)
- ✅ Hook batching
- ✅ Unified observability
- ✅ Policy pack support

## Next Steps

1. **Review** this analysis with team
2. **Prioritize** features based on v1.0 requirements
3. **Design** enhanced API for v1.0
4. **Implement** P0 features first
5. **Test** integration thoroughly
6. **Document** v1.0 integration architecture

---

**Status**: Analysis Complete  
**Next Action**: Review and prioritize features for v1.0 implementation

