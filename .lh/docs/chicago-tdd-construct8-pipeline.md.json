{
    "sourceFile": "docs/chicago-tdd-construct8-pipeline.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1762376291506,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1762376291506,
            "name": "Commit-0",
            "content": "# Chicago TDD: Full CONSTRUCT8 Pipeline Tests\n\n## Overview\n\nComprehensive Chicago TDD test suite for the complete CONSTRUCT8 pipeline: **Rust → C → Rust**\n\n## Pipeline Flow\n\n```\n1. Rust Warm Path (Warm)\n   └─> Parse Turtle (rio_turtle)\n   └─> Prepare CONSTRUCT8 IR\n   └─> Hash IRIs to u64 IDs\n   └─> Validate guards (run.len ≤ 8)\n   └─> Prepare SoA arrays (64-byte aligned)\n   │\n2. C Hot Path (≤8 ticks / ≤2ns) ⚡\n   └─> Execute CONSTRUCT8 (knhk_eval_construct8)\n   └─> SIMD operations (load-mask-blend-store)\n   └─> Emit triples to output arrays\n   └─> Generate receipt (span_id, a_hash)\n   │\n3. Rust Warm Path (Warm)\n   └─> Process results\n   └─> Verify output triples\n   └─> Validate receipt\n   └─> Return constructed triples\n```\n\n## Test Files\n\n### 1. C Test: `tests/chicago_construct8_pipeline.c`\n\n**Purpose**: End-to-end pipeline test using C test framework\n\n**Tests**:\n- `test_pipeline_turtle_parsing()`: Full pipeline with Turtle file parsing\n- `test_pipeline_manual_triples()`: Full pipeline with manual triple setup\n- `test_pipeline_prefix_resolution()`: Prefix resolution → C hot path → result processing\n- `test_pipeline_performance()`: Performance validation (1000 iterations, ≤8 ticks)\n- `test_pipeline_error_handling()`: Error handling (empty runs, invalid inputs)\n- `test_pipeline_idempotence()`: Idempotence test (μ∘μ = μ)\n\n**Run**: `make test-construct8-pipeline`\n\n### 2. Rust Test: `rust/knhk-integration-tests/tests/construct8_pipeline.rs`\n\n**Purpose**: Full pipeline test using Rust FFI to C hot path\n\n**Tests**:\n- `test_construct8_pipeline_rust_to_c_to_rust()`: Complete pipeline using Rust FFI\n- `test_construct8_pipeline_performance()`: Performance validation (1000 iterations)\n- `test_construct8_pipeline_idempotence()`: Idempotence verification\n\n**Run**: `cd rust/knhk-integration-tests && cargo test construct8_pipeline`\n\n## Chicago TDD Principles Applied\n\n### ✅ No Mocks, Real Implementations Only\n- Uses real `rio_turtle` parser (not mocked)\n- Uses real C hot path (`knhk_eval_construct8`)\n- Uses real FFI layer (`knhk_hot::Engine`)\n\n### ✅ Direct Assertions on Behavior\n- Asserts triple count matches expected\n- Asserts output triples match template\n- Asserts receipt fields are populated\n- Asserts performance constraints (≤8 ticks)\n\n### ✅ Performance Validation\n- Measures timing around C hot path call\n- Validates ≤8 ticks (Chatman Constant)\n- Validates ≤2ns (2.0 nanoseconds)\n- Cache warming before measurement\n- 1000 iterations for statistical significance\n\n### ✅ End-to-End Verification\n- Tests complete pipeline (Rust → C → Rust)\n- Tests data flow correctness\n- Tests error handling\n- Tests idempotence (μ∘μ = μ)\n\n## Test Scenarios\n\n### Scenario 1: Basic Pipeline\n```c\n// 1. Parse Turtle\nknhk_rdf_load(\"tests/data/enterprise_authorization.ttl\", S, P, O, NROWS, &count);\n\n// 2. Prepare IR\nknhk_pin_run(&ctx, (knhk_pred_run_t){.pred = pred, .off = 0, .len = count});\n\n// 3. Execute CONSTRUCT8 (C hot path)\nknhk_eval_construct8(&ctx, &ir, &rcpt);\n\n// 4. Verify results\nassert(written > 0);\nassert(rcpt.ticks <= 8);\n```\n\n### Scenario 2: Prefix Resolution\n```c\n// Turtle with prefixes\n@prefix ex: <http://example.org/> .\nex:alice ex:role ex:admin .\n\n// Rust warm path resolves prefixes → full IRIs\n// C hot path receives hashed IRIs\n// Result: Correct triples emitted\n```\n\n### Scenario 3: Performance Validation\n```c\n// Cache warming\nfor (int i = 0; i < 100; i++) {\n    knhk_eval_construct8(&ctx, &ir, &rcpt);\n}\n\n// Measure 1000 iterations\nfor (int i = 0; i < 1000; i++) {\n    uint64_t t0 = knhk_rd_ticks();\n    knhk_eval_construct8(&ctx, &ir, &rcpt);\n    uint64_t t1 = knhk_rd_ticks();\n    // Validate ≤8 ticks\n}\n```\n\n## Key Validations\n\n### 1. Data Flow Correctness\n- ✅ Input triples parsed correctly\n- ✅ IRIs hashed correctly (FNV-1a)\n- ✅ SoA arrays prepared correctly\n- ✅ Output triples match template\n- ✅ Receipt fields populated correctly\n\n### 2. Performance Constraints\n- ✅ C hot path ≤8 ticks (Chatman Constant)\n- ✅ C hot path ≤2ns (2.0 nanoseconds)\n- ✅ Cache warming applied\n- ✅ Prefetch hints used (where applicable)\n\n### 3. Error Handling\n- ✅ Empty runs handled correctly\n- ✅ Invalid inputs rejected\n- ✅ Error messages include context\n\n### 4. Idempotence\n- ✅ Same input → same output (μ∘μ = μ)\n- ✅ Deterministic execution\n- ✅ Receipt consistency\n\n## Build & Run\n\n### C Tests\n```bash\n# Build\nmake test-construct8-pipeline\n\n# Run\n./tests/chicago_construct8_pipeline\n\n# Or via Makefile\nmake test-construct8-pipeline\n```\n\n### Rust Tests\n```bash\n# Build and run\ncd rust/knhk-integration-tests\ncargo test construct8_pipeline\n\n# With output\ncargo test construct8_pipeline -- --nocapture\n```\n\n## Expected Output\n\n### C Test Output\n```\n========================================\nChicago TDD: Full CONSTRUCT8 Pipeline\nRust → C → Rust Integration Tests\n========================================\n\n[TEST] Full Pipeline: Turtle Parsing → C Hot Path → Result Processing\n  ✓ Parsed 8 triples from Turtle file\n  ✓ Pipeline executed: 8 triples emitted, ticks=6, ns=1.50\n  ✓ Receipt: lanes=8, span_id=0x1234..., a_hash=0x5678...\n\n[TEST] Full Pipeline: Manual Triples → C Hot Path → Result Processing\n  ✓ Pipeline executed: 3 triples emitted, ticks=4, ns=1.00\n\n[TEST] Full Pipeline: Prefix Resolution → C Hot Path → Result Processing\n  ✓ Pipeline executed with prefix resolution: 2 triples, ticks=4, ns=1.00\n\n[TEST] Full Pipeline: Performance Validation (1000 iterations)\n  Max ticks observed: 6 (budget = 8)\n  Max nanoseconds observed: 1.50 (budget = 2.00)\n  ✓ Performance validation passed: max_ticks=6, max_ns=1.50\n\n[TEST] Full Pipeline: Error Handling\n  ✓ Empty run handled correctly\n  ✓ Error handling validated\n\n[TEST] Full Pipeline: Idempotence (μ∘μ = μ)\n  ✓ Pipeline is idempotent (μ∘μ = μ)\n\n========================================\nResults: 6/6 tests passed\n========================================\n```\n\n### Rust Test Output\n```\nrunning 3 tests\ntest construct8_pipeline::test_construct8_pipeline_rust_to_c_to_rust ... ok\ntest construct8_pipeline::test_construct8_pipeline_performance ... ok\ntest construct8_pipeline::test_construct8_pipeline_idempotence ... ok\n\ntest result: ok. 3 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\n```\n\n## Integration Points\n\n### Rust → C FFI\n- `knhk_hot::Engine`: Safe Rust wrapper around C hot path\n- `knhk_hot::Ir`: FFI-safe IR structure\n- `knhk_hot::Receipt`: FFI-safe receipt structure\n\n### C → Rust Data Flow\n- Rust prepares SoA arrays (64-byte aligned)\n- Rust calls C hot path via FFI\n- C executes CONSTRUCT8 (≤8 ticks)\n- C fills output arrays and receipt\n- Rust processes results\n\n## Performance Targets\n\n| Component | Target | Validation |\n|-----------|--------|------------|\n| **C Hot Path** | ≤8 ticks | Assert in test |\n| **C Hot Path** | ≤2ns | Assert in test |\n| **Rust Warm Path** | <500ms | Not validated (warm path) |\n| **Total Pipeline** | <500ms | Not validated (warm path) |\n\n## Notes\n\n- **C hot path only**: Performance validation applies to C hot path execution only\n- **Rust warm path**: Parsing and preparation are warm path (no tick budget)\n- **Cache warming**: Tests include cache warming before measurement\n- **Real implementations**: No mocks, all real components\n\n## Future Enhancements\n\n1. **Rust FFI Integration**: Full Rust → C → Rust test using FFI\n2. **Streaming Tests**: Test with large Turtle files (streaming parser)\n3. **Error Recovery**: Test error recovery scenarios\n4. **Batch Processing**: Test batch CONSTRUCT8 operations\n5. **Receipt Merging**: Test receipt merging (⊕ operation)\n\n"
        }
    ]
}