import { createDarkMatterCore } from './src/knowledge-engine/knowledge-substrate-core.mjs';
import { parseTurtle } from './src/knowledge-engine/parse.mjs';

async function main() {
    const system = await createDarkMatterCore({
        enableKnowledgeHookManager: true,
        enableLockchainWriter: false
    });

    const dataTurtle = `{{ data_turtle | escape_js }}`;
    const shapesTurtle = `{{ shapes_turtle | escape_js }}`;

    try {
        const dataStore = await parseTurtle(dataTurtle);
        const shapesStore = await parseTurtle(shapesTurtle);

        const validation = await system.validate({
            dataGraph: dataStore,
            shapesGraph: shapesStore
        });

        const violations = [];
        for (const report of validation.report.results) {
            violations.push({
                path: report.path ? report.path.value : null,
                message: report.message ? report.message[0].value : '',
                severity: report.severity ? report.severity.value : null,
                focus_node: report.focusNode ? report.focusNode.value : null,
                value: report.value ? report.value.value : null
            });
        }

        console.log(JSON.stringify({
            conforms: validation.conforms,
            violations: violations
        }));
    } catch (err) {
        console.error(JSON.stringify({
            conforms: false,
            violations: [],
            error: err.message
        }));
        process.exit(1);
    }
}

main().catch(err => {
    console.error(JSON.stringify({
        conforms: false,
        violations: [],
        error: err.message
    }));
    process.exit(1);
});

