import { createDarkMatterCore } from './src/knowledge-engine/knowledge-substrate-core.mjs';
import { parseTurtle } from './src/knowledge-engine/parse.mjs';

async function main() {
    const system = await createDarkMatterCore({
        enableKnowledgeHookManager: true,
        enableLockchainWriter: false
    });

    // Store data first
    const turtleData = `{{ turtle_data | escape_js }}`;
    const store = await parseTurtle(turtleData);
    const quads = [];
    store.forEach(q => quads.push(q));
    await system.executeTransaction({
        additions: quads,
        removals: [],
        actor: 'knhk-rust'
    });

    // Then query
    const query = `{{ query | escape_js }}`;
    const queryType = '{{ query_type }}';

    let results;
    let resultData = { success: true, query_type: queryType };

    try {
        if (queryType === 'sparql-ask') {
            results = await system.query({
                query: query,
                type: queryType
            });
            resultData.boolean = results;
        } else if (queryType === 'sparql-construct' || queryType === 'sparql-describe') {
            results = await system.query({
                query: query,
                type: queryType
            });
            const triples = [];
            for await (const quad of results) {
                triples.push({
                    subject: quad.subject.value,
                    predicate: quad.predicate.value,
                    object: quad.object.value,
                    graph: quad.graph ? quad.graph.value : null
                });
            }
            resultData.triples = triples;
        } else if (queryType === 'sparql-update') {
            await system.query({
                query: query,
                type: queryType
            });
            resultData.success = true;
        } else {
            // SELECT query
            results = await system.query({
                query: query,
                type: queryType
            });
            const bindings = [];
            // Handle async iterable results
            if (results && typeof results[Symbol.asyncIterator] === 'function') {
                for await (const binding of results) {
                    const bindingObj = {};
                    // Handle both Map and object formats
                    if (binding instanceof Map) {
                        for (const [key, value] of binding) {
                            bindingObj[key] = value?.value || value || '';
                        }
                    } else if (typeof binding === 'object' && binding !== null) {
                        // Handle plain object format
                        for (const key in binding) {
                            const value = binding[key];
                            bindingObj[key] = value?.value || value || '';
                        }
                    } else {
                        // Single value binding
                        bindingObj.value = binding?.value || binding || '';
                    }
                    bindings.push(bindingObj);
                }
            } else if (Array.isArray(results)) {
                // Handle array results
                for (const binding of results) {
                    const bindingObj = {};
                    if (binding instanceof Map) {
                        for (const [key, value] of binding) {
                            bindingObj[key] = value?.value || value || '';
                        }
                    } else if (typeof binding === 'object' && binding !== null) {
                        for (const key in binding) {
                            const value = binding[key];
                            bindingObj[key] = value?.value || value || '';
                        }
                    }
                    bindings.push(bindingObj);
                }
            } else if (results && typeof results === 'object') {
                // Single result object
                const bindingObj = {};
                for (const key in results) {
                    const value = results[key];
                    bindingObj[key] = value?.value || value || '';
                }
                bindings.push(bindingObj);
            }
            resultData.bindings = bindings;
        }

        console.log(JSON.stringify(resultData));
    } catch (err) {
        console.error(JSON.stringify({
            success: false,
            query_type: queryType,
            error: err.message
        }));
        process.exit(1);
    }
}

main().catch(err => {
    console.error(JSON.stringify({
        success: false,
        error: err.message
    }));
    process.exit(1);
});

