@startuml C2_Container
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
LAYOUT_TOP_DOWN()

System_Boundary(knhk, "KNHK Workflow Engine") {
  Container(api, "REST API Server", "Axum", "REST endpoints for workflow operations")
  Container(grpc, "gRPC Server", "Tonic", "gRPC services for workflow operations")
  Container(engine, "Workflow Engine", "Rust", "Core workflow execution engine")
  Container(reg, "Pattern Registry", "Rust", "Pattern dispatch and metadata (43 patterns)")
  Container(parser, "Workflow Parser", "Rust + Oxigraph", "Parse YAWL/Turtle workflow specs")
  Container(alloc, "Resource Allocator", "Rust", "Resource allocation policies")
  Container(worklets, "Worklet Repository", "Rust", "Exception handling worklets")
  Container(obs, "Observability", "OTEL", "Distributed tracing and metrics")
  Container(prov, "Provenance Tracker", "Lockchain", "Audit trails and receipts")
  ContainerDb(db, "State Store", "Sled", "Persistent storage for specs, cases, state")
}

Rel(api, engine, "Register workflows, create cases, execute")
Rel(grpc, engine, "gRPC workflow operations")
Rel(engine, parser, "Parse workflow specifications")
Rel(engine, reg, "Execute patterns (1-43)")
Rel(reg, alloc, "Request resources for pattern execution")
Rel(engine, worklets, "Handle exceptions via worklets")
Rel(engine, db, "Persist workflow specs and case state")
Rel(api, db, "Query workflow state")
Rel(engine, obs, "Emit traces and metrics")
Rel(engine, prov, "Generate provenance receipts")
@enduml

