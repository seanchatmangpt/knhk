{#- YAWL XML Template -#}
{#- Generates YAWL 2.2 XML specification from RDF ontology -#}
{#- SPARQL-driven semantic code generation from RDF ontologies -#}
{%- set x_coords = [50, 150, 250, 350, 450, 550, 650] -%}
{%- set y_coords = [50, 150, 250, 350, 450] -%}
<?xml version="1.0" encoding="UTF-8"?>
<YAWL xmlns="http://www.yawlfoundation.org/yawlschema/YAWL_Schema_Version_2.2">
  <SpecificationSet>
    {%- for workflow in workflows %}
    <Specification URI="{{ workflow.workflow }}">
      {#- Metadata Section -#}
      <Metadata>
        <Title>{{ workflow.workflowLabel | default("Unnamed Workflow") }}</Title>
        <Description>{{ workflow.workflowDescription | default("No description provided") }}</Description>
        <Creator>KNHK YAWL Generator</Creator>
        <Version>1.0</Version>
        <Identifier>{{ workflow.workflow | regex_replace('[#/:]', '_') }}</Identifier>
      </Metadata>

      {#- Net Definition (Petri Net Structure) -#}
      <Net id="workflow_net">
        {#- Input Condition (Start Place) -#}
        <Place id="input_condition">
          <Name>Start</Name>
          <Graphics>
            <Position x="0" y="0" />
          </Graphics>
          <Token id="Default" value="True" />
        </Place>

        {#- Workflow Conditions (Places) from SPARQL extraction -#}
        {%- for condition in conditions %}
        {%- if condition.conditionLabel %}
        {%- set cond_id = condition.condition | regex_replace('[#/:]', '_') %}
        <Place id="{{ cond_id }}">
          <Name>{{ condition.conditionLabel }}</Name>
          {%- if condition.conditionDescription %}
          <Documentation>{{ condition.conditionDescription }}</Documentation>
          {%- endif %}
          <Graphics>
            <Position x="{{ x_coords[loop.index0 % x_coords | length] }}" y="{{ y_coords[loop.index0 % y_coords | length] }}" />
          </Graphics>
          <Token id="Default" value="{{ condition.initialMarking | default(0) }}" />
        </Place>
        {%- endif %}
        {%- endfor %}

        {#- Output Condition (End Place) -#}
        <Place id="output_condition">
          <Name>End</Name>
          <Graphics>
            <Position x="700" y="200" />
          </Graphics>
        </Place>

        {#- Tasks (Transitions) from SPARQL extraction -#}
        {%- for task in tasks %}
        {%- if task.taskLabel %}
        {%- set task_id = task.task | regex_replace('[#/:]', '_') %}
        <Transition id="{{ task_id }}">
          <Name>{{ task.taskLabel }}</Name>
          {%- if task.taskDescription %}
          <Documentation>{{ task.taskDescription }}</Documentation>
          {%- endif %}

          {#- Task Split/Join Routing Configuration -#}
          {%- if task.splitType or task.joinType or task.isMultiInstance %}
          <Configuration>
            <Documentation>
              {%- if task.splitType %}
              <Text>Split: {{ task.splitType }}</Text>
              {%- endif %}
              {%- if task.joinType %}
              <Text>Join: {{ task.joinType }}</Text>
              {%- endif %}
              {%- if task.isMultiInstance %}
              <Text>MultiInstance: true</Text>
              {%- endif %}
            </Documentation>
          </Configuration>
          {%- endif %}

          <Graphics>
            <Position x="{{ x_coords[loop.index0 % x_coords | length] }}" y="{{ y_coords[(loop.index0 + 1) % y_coords | length] }}" />
            <Size width="80" height="50" />
          </Graphics>
        </Transition>
        {%- endif %}
        {%- endfor %}

        {#- Flow Connections (Arcs) -#}
        {%- for flow in flows %}
        {%- set source_id = flow.source | regex_replace('[#/:]', '_') %}
        {%- set target_id = flow.target | regex_replace('[#/:]', '_') %}
        {%- set arc_id = 'arc_' + source_id + '_to_' + target_id %}
        <Arc id="{{ arc_id }}" source="{{ source_id }}" target="{{ target_id }}">
          {%- if flow.flowLabel %}
          <Label>{{ flow.flowLabel }}</Label>
          {%- endif %}
          {%- if flow.flowCondition or flow.flowPredicate %}
          <Predicate>{{ flow.flowCondition or flow.flowPredicate }}</Predicate>
          {%- endif %}
        </Arc>
        {%- endfor %}
      </Net>

      {#- Visual Layout Information -#}
      <Layout>
        <GraphicalDescription>
          <Size x="800" y="600" />
          <NetGraphicalDescription id="workflow_net">
            <SizeConstraints x="800" y="600" />
            <Viewport x="0" y="0" />
          </NetGraphicalDescription>
        </GraphicalDescription>
      </Layout>
    </Specification>
    {%- endfor %}
  </SpecificationSet>
</YAWL>
