name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================
  # LEVEL 1: Weaver Schema Validation (MANDATORY)
  # ============================================
  weaver-validation:
    name: Weaver Registry Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Weaver
        run: |
          curl -sSL https://github.com/open-telemetry/weaver/releases/download/v0.9.0/weaver-linux-x86_64 -o weaver
          chmod +x weaver
          sudo mv weaver /usr/local/bin/

      - name: Validate OTel Registry Schema
        run: weaver registry check -r registry/
        continue-on-error: false

      - name: Comment on PR (Schema Validation Failed)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **CRITICAL: Weaver schema validation failed!**\n\nThe OTel registry schema is invalid. This is the source of truth for KNHK and MUST pass before any code can be merged.'
            })

  # ============================================
  # LEVEL 2: Compilation & Code Quality
  # ============================================
  build-and-lint:
    name: Build and Lint
    runs-on: ${{ matrix.os }}
    needs: weaver-validation
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy, rustfmt

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install system dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install raptor2 || true

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libraptor2-dev pkg-config || true

      - name: Build all crates
        run: |
          for crate in rust/knhk-*; do
            if [ -d "$crate" ] && [ -f "$crate/Cargo.toml" ]; then
              echo "Building $crate..."
              (cd "$crate" && cargo build --all-features)
            fi
          done

      - name: Run Clippy (all crates)
        run: |
          for crate in rust/knhk-*; do
            if [ -d "$crate" ] && [ -f "$crate/Cargo.toml" ]; then
              echo "Linting $crate..."
              (cd "$crate" && cargo clippy --all-features -- -D warnings)
            fi
          done

      - name: Check code formatting
        run: |
          for crate in rust/knhk-*; do
            if [ -d "$crate" ] && [ -f "$crate/Cargo.toml" ]; then
              echo "Checking format $crate..."
              (cd "$crate" && cargo fmt -- --check)
            fi
          done

      - name: Check for unsafe code patterns
        run: |
          echo "Checking for .unwrap() in production code..."
          if grep -r "\.unwrap()" rust/*/src --include="*.rs" | grep -v "test" | grep -v "example"; then
            echo "‚ùå Found .unwrap() in production code"
            exit 1
          fi
          echo "‚úÖ No .unwrap() found in production code"

  # ============================================
  # LEVEL 3: Traditional Tests
  # ============================================
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    needs: build-and-lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install raptor2 || true

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libraptor2-dev pkg-config || true

      - name: Run unit tests (all crates)
        run: |
          for crate in rust/knhk-*; do
            if [ -d "$crate" ] && [ -f "$crate/Cargo.toml" ]; then
              echo "Testing $crate..."
              (cd "$crate" && cargo test --all-features)
            fi
          done

      - name: Run integration tests
        if: hashFiles('rust/knhk-integration-tests/Cargo.toml') != ''
        run: |
          cd rust/knhk-integration-tests
          cargo test --all-features

      - name: Generate test coverage report
        if: matrix.os == 'ubuntu-latest'
        run: |
          cargo install cargo-tarpaulin || true
          cargo tarpaulin --out Xml --workspace || true

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          files: ./cobertura.xml
          fail_ci_if_error: false

  # ============================================
  # Production Readiness Check
  # ============================================
  production-ready:
    name: Production Readiness Validation
    runs-on: ubuntu-latest
    needs: [weaver-validation, build-and-lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Weaver
        run: |
          curl -sSL https://github.com/open-telemetry/weaver/releases/download/v0.9.0/weaver-linux-x86_64 -o weaver
          chmod +x weaver
          sudo mv weaver /usr/local/bin/

      - name: Run production readiness validation
        run: ./scripts/validate-production-ready.sh

      - name: Comment on PR (Success)
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **All validation checks passed!**\n\n- ‚úÖ Weaver registry schema valid\n- ‚úÖ Zero compilation warnings\n- ‚úÖ Zero Clippy issues\n- ‚úÖ All tests passing\n- ‚úÖ No unsafe code patterns\n\nCode is production-ready! üöÄ'
            })

      - name: Comment on PR (Failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Production readiness validation failed!**\n\nPlease review the CI logs and fix all issues before merging.'
            })

  # ============================================
  # Security Audit
  # ============================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run cargo audit
        run: |
          cargo install cargo-audit || true
          cargo audit || true

      - name: Run cargo deny
        run: |
          cargo install cargo-deny || true
          cargo deny check || true
