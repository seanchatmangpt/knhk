name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # Build and test Rust crates
  rust-tests:
    name: Rust Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, nightly]
        exclude:
          - os: macos-latest
            rust: nightly

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy, rustfmt

      - name: Install cargo-nextest
        uses: taiki-e/install-action@cargo-nextest

      - name: Install cargo-deny
        uses: taiki-e/install-action@cargo-deny

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/*/target/
          key: ${{ runner.os }}-cargo-${{ matrix.rust }}-${{ hashFiles('rust/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.rust }}-
            ${{ runner.os }}-cargo-

      - name: Check Rust formatting
        if: matrix.rust == 'stable'
        run: |
          for crate in rust/*/Cargo.toml; do
            if [ -f "$crate" ]; then
              dir=$(dirname "$crate")
              echo "Checking formatting in $dir..."
              (cd "$dir" && cargo fmt -- --check) || exit 1
            fi
          done

      - name: Run Clippy
        if: matrix.rust == 'stable'
        run: make lint-rust

      - name: Check dependencies with cargo-deny
        if: matrix.rust == 'stable'
        run: |
          cd rust
          cargo deny check

      - name: Build Rust crates
        run: make build-rust

      - name: Run Rust tests with cargo-nextest
        run: |
          cd rust
          cargo nextest run --workspace --profile ci
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.rust }}
          path: rust/test-results.xml
          retention-days: 7

  # Shell script tests
  shell-tests:
    name: Shell Script Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install bats
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Run shell script tests
        run: make test-shell

  # C library tests
  c-tests:
    name: C Library Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        exclude:
          - os: macos-latest
            compiler: gcc

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libraptor2-dev pkg-config

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install raptor pkg-config

      - name: Set compiler
        run: echo "CC=${{ matrix.compiler }}" >> $GITHUB_ENV

      - name: Build C library
        run: make build-c

      - name: Run C tests
        run: make test-c

  # Chicago TDD tests
  chicago-tdd:
    name: Chicago TDD Tests
    runs-on: ubuntu-latest
    needs: [rust-tests, c-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@cargo-nextest

      - name: Install C dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libraptor2-dev pkg-config clang

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/*/target/
          key: chicago-${{ runner.os }}-${{ hashFiles('rust/**/Cargo.lock') }}

      - name: Build all
        run: make build

      - name: Run Chicago TDD tests
        run: make test-chicago-v04

  # Performance tests
  performance:
    name: Performance Tests (τ ≤ 8)
    runs-on: ubuntu-latest
    needs: [rust-tests, c-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@cargo-nextest

      - name: Install C dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libraptor2-dev pkg-config clang

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/*/target/
          key: perf-${{ runner.os }}-${{ hashFiles('rust/**/Cargo.lock') }}

      - name: Build with optimizations
        run: make build

      - name: Run performance tests
        run: make test-performance-v04

  # Integration tests
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [rust-tests, c-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@cargo-nextest

      - name: Install C dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libraptor2-dev pkg-config clang

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/*/target/
          key: integration-${{ runner.os }}-${{ hashFiles('rust/**/Cargo.lock') }}

      - name: Build all
        run: make build

      - name: Run integration tests
        run: make test-integration-v2

  # Complete test suite
  complete-suite:
    name: Complete Test Suite
    runs-on: ubuntu-latest
    needs: [chicago-tdd, performance, integration, shell-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@cargo-nextest

      - name: Install C dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libraptor2-dev pkg-config clang

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/*/target/
          key: complete-${{ runner.os }}-${{ hashFiles('rust/**/Cargo.lock') }}

      - name: Build all
        run: make build

      - name: Run complete test suite
        run: make test-all

      - name: Generate test report
        if: always()
        run: |
          echo "## Test Results" > $GITHUB_STEP_SUMMARY
          echo "✅ Complete test suite passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Chicago TDD tests: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Performance tests (τ ≤ 8): ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Integration tests: ✅" >> $GITHUB_STEP_SUMMARY
